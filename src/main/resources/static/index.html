<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoBazaar - Carbon-Aware Marketplace</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --primary-green: #2ecc71;
            --dark-green: #27ae60;
            --bg-color: #f0fdf4;
            --text-color: #2c3e50;
            --card-bg: #ffffff;
            --danger: #e74c3c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); color: var(--text-color); }
        .hidden { display: none !important; }

        /* Auth Page */
        .auth-wrapper { display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .auth-container { background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1);
                         width: 900px; max-width: 90%; display: flex; min-height: 600px; }
        .info-side { flex: 1; background: linear-gradient(to bottom right, var(--dark-green), var(--primary-green));
                     color: white; padding: 40px; display: flex; flex-direction: column; justify-content: center;
                     align-items: center; text-align: center; }
        .form-side { flex: 1.2; padding: 50px; display: flex; flex-direction: column; justify-content: center; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .input-group input, .input-group select { width: 100%; padding: 12px; border: 1px solid #e2e8f0;
                                                  border-radius: 8px; background: #f8fafc; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--primary-green); color: white; }
        .btn-primary:hover { background: var(--dark-green); }
        .btn-outline { border: 2px solid var(--primary-green); color: var(--primary-green); background: transparent; }
        .btn-danger { background: var(--danger); color: white; }

        /* App Layout */
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        .navbar { background: white; padding: 15px 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
                 display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .logo { font-size: 1.5rem; font-weight: 800; color: var(--dark-green); }
        .nav-links { display: flex; gap: 20px; }
        .nav-item { cursor: pointer; color: #64748b; font-weight: 600; padding: 8px 12px; border-radius: 6px; }
        .nav-item:hover, .nav-item.active { color: var(--primary-green); background: #f0fdf4; }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; max-width: 1200px; margin: 0 auto; width: 100%; }

        /* Search & Filter Bar */
        .search-container { background: white; padding: 20px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; gap: 15px; flex-wrap: wrap; align-items: end; }
        .filter-group { flex: 1; min-width: 150px; }
        .filter-group label { display: block; font-size: 0.8rem; margin-bottom: 5px; font-weight: bold; }
        .filter-group input, .filter-group select { width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; }

        /* Products */
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 25px; }
        .product-card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
                       display: flex; flex-direction: column; }
        .product-card:hover { transform: translateY(-5px); transition: 0.2s; }
        .product-img { height: 150px; background: #eee; border-radius: 8px; margin-bottom: 15px; object-fit: cover; width: 100%; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        .badge-A-plus { background: #00b894; color: white; }
        .badge-B { background: #ffeaa7; color: #2d3436; }
        .badge-C { background: #fab1a0; color: white; }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .stat-value { font-size: 2rem; font-weight: 800; color: var(--primary-green); margin: 10px 0; }

        /* Tables */
        .data-table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; }
        .data-table th, .data-table td { padding: 15px; text-align: left; border-bottom: 1px solid #f1f2f6; }
        .data-table th { background: #f8fafc; font-weight: 600; }

        /* Modal for Edit */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 600px; max-width: 90%; max-height: 90vh; overflow-y: auto; }
    </style>
</head>
<body>

<!-- AUTH VIEW -->
<div id="auth-view" class="auth-wrapper">
    <div class="auth-container">
        <div class="info-side">
            <h1>EcoBazaar</h1>
            <p>Shop sustainably. Track your carbon impact. Make a difference.</p>
            <button class="btn btn-outline" style="color: white; border-color: white; margin-top: 20px;"
                    onclick="toggleAuthMode()">Sign Up</button>
        </div>
        <div class="form-side">
            <!-- Login -->
            <div id="loginForm">
                <h2 style="text-align: center; color: var(--dark-green); margin-bottom: 30px;">Sign In</h2>
                <form onsubmit="handleLogin(event)">
                    <div class="input-group">
                        <label>Email</label>
                        <input type="email" name="email" required>
                    </div>
                    <div class="input-group">
                        <label>Password</label>
                        <input type="password" name="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Sign In</button>
                </form>
            </div>

            <!-- Register -->
            <div id="registerForm" class="hidden">
                <h2 style="text-align: center; color: var(--dark-green); margin-bottom: 30px;">Create Account</h2>
                <form onsubmit="handleRegister(event)">
                    <div class="input-group">
                        <label>Full Name</label>
                        <input type="text" name="fullName" required>
                    </div>
                    <div class="input-group">
                        <label>Email</label>
                        <input type="email" name="email" required>
                    </div>
                    <div class="input-group">
                        <label>Password</label>
                        <input type="password" name="password" required>
                    </div>
                    <div class="input-group">
                        <label>I am a...</label>
                        <select name="role">
                            <option value="USER">Shopper</option>
                            <option value="SELLER">Seller</option>
                            <option value="ADMIN">Admin</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Sign Up</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- APP VIEW -->
<div id="app-view" class="app-container hidden">
    <nav class="navbar">
        <div class="logo"><i class="fas fa-leaf"></i> EcoBazaar</div>
        <div class="nav-links" id="navLinks"></div>
        <div>
            <span id="userName" style="margin-right: 15px;">User</span>
            <button onclick="logout()" class="btn btn-outline" style="padding: 5px 10px; font-size: 0.8rem;">Logout</button>
        </div>
    </nav>

    <div class="main-content">
        <!-- Shop Section -->
        <div id="shop-section" class="section">
            <h2>Eco-Friendly Products</h2>

            <!-- Search & Filters -->
            <div class="search-container">
                <div class="filter-group" style="flex: 2;">
                    <label>Search Product</label>
                    <input type="text" id="searchName" placeholder="e.g. Bamboo Toothbrush">
                </div>
                <div class="filter-group">
                    <label>Category</label>
                    <select id="searchCategory">
                        <option value="All">All Categories</option>
                        <option value="Electronics">Electronics</option>
                        <option value="Fashion">Fashion</option>
                        <option value="Home">Home</option>
                        <option value="Food">Food</option>
                        <option value="Beauty">Beauty</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Max Price ($)</label>
                    <input type="number" id="searchMaxPrice" placeholder="Max Price">
                </div>
                <div class="filter-group">
                    <label>Max Carbon (kg)</label>
                    <input type="number" id="searchMaxCarbon" placeholder="Max CO2">
                </div>
                <button class="btn btn-primary" onclick="loadShop()" style="height: 42px;">Search</button>
            </div>

            <div id="productsGrid" class="products-grid"></div>
        </div>

        <!-- Cart Section -->
        <div id="cart-section" class="section hidden">
            <h2>Your Cart</h2>
            <div id="cartItems"></div>
            <div style="margin-top: 20px;">
                <h3>Total: $<span id="cartTotal">0.00</span></h3>
                <button class="btn btn-primary" onclick="checkout()">Place Order</button>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard-section" class="section hidden">
            <h2>Your Carbon Impact Dashboard</h2>
            <div class="stats-grid" id="statsGrid"></div>
            <div style="background: white; padding: 20px; border-radius: 12px; margin-top: 30px;">
                <h3>Your Carbon Footprint Over Time</h3>
                <canvas id="carbonTrendChart" style="max-height: 300px;"></canvas>
            </div>
            <div style="margin-top: 30px;">
                <h3>Recent Orders</h3>
                <div id="userOrders"></div>
            </div>
        </div>

        <!-- Seller Section -->
        <div id="seller-section" class="section hidden">
            <h2>Seller Dashboard</h2>
            <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                <h3>Add New Product</h3>
                <form id="addProductForm" onsubmit="handleProductSubmit(event)" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <input type="hidden" name="productId" id="editProductId"> <!-- For Editing -->
                    <input type="hidden" name="imagePath" id="imagePathHidden"> <!-- Store uploaded file path -->

                    <div class="input-group">
                        <label>Name</label>
                        <input type="text" name="name" id="prodName" required>
                    </div>
                    <div class="input-group">
                        <label>Price ($)</label>
                        <input type="number" step="0.01" name="price" id="prodPrice" required>
                    </div>
                    <div class="input-group">
                        <label>Quantity</label>
                        <input type="number" name="quantity" id="prodQuantity" value="1" required>
                    </div>
                    <div class="input-group">
                        <label>Category</label>
                        <select name="category" id="prodCategory" required>
                            <option value="Electronics">Electronics</option>
                            <option value="Fashion">Fashion</option>
                            <option value="Home">Home</option>
                            <option value="Food">Food</option>
                            <option value="Beauty">Beauty</option>
                        </select>
                    </div>
                    <div class="input-group" style="grid-column: span 2;">
                        <label>Product Image</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="file" id="imageInput" accept="image/*" style="flex: 1;">
                            <button type="button" class="btn btn-primary" onclick="uploadImageFile()">Upload</button>
                        </div>
                        <small id="uploadStatus" style="color: #666; margin-top: 5px; display: block;"></small>
                    </div>
                    <div class="input-group" style="grid-column: span 2;">
                        <label>Description</label>
                        <textarea name="description" id="prodDesc" required></textarea>
                    </div>

                    <div style="grid-column: span 2; background: #f8fafc; padding: 15px; border-radius: 8px;">
                        <h4 style="margin-bottom: 10px;">Carbon Data (Optional - Leave 0 for Auto-Calc)</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                            <div><label>Manufacturing</label><input type="number" step="0.1" name="manufacturing" id="prodManu" value="0"></div>
                            <div><label>Transport</label><input type="number" step="0.1" name="transportation" id="prodTrans" value="0"></div>
                            <div><label>Packaging</label><input type="number" step="0.1" name="packaging" id="prodPack" value="0"></div>
                            <div><label>Usage</label><input type="number" step="0.1" name="usage" id="prodUsage" value="0"></div>
                            <div><label>Disposal</label><input type="number" step="0.1" name="disposal" id="prodDisp" value="0"></div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary" style="grid-column: span 2;" id="submitProductBtn">Add Product</button>
                    <button type="button" class="btn btn-outline" style="grid-column: span 2; display: none;" id="cancelEditBtn" onclick="resetForm()">Cancel Edit</button>
                </form>
            </div>
            <h3>My Products</h3>
            <div id="sellerProducts"></div>
        </div>

        <!-- Admin Section -->
        <div id="admin-section" class="section hidden">
            <h2>Admin Dashboard</h2>
            <h3>Pending Verifications</h3>
            <table class="data-table" style="margin-bottom: 30px;">
                <thead><tr><th>Product</th><th>Seller</th><th>Carbon</th><th>Action</th></tr></thead>
                <tbody id="pendingProducts"></tbody>
            </table>

            <h3>All Products Management</h3>
            <div class="search-container">
                <div class="filter-group">
                    <label>Filter by Name</label>
                    <input type="text" id="adminSearchName" placeholder="Search...">
                </div>
                <button class="btn btn-primary" onclick="loadAdminAllProducts()">Refresh</button>
            </div>
            <table class="data-table">
                <thead><tr><th>ID</th><th>Name</th><th>Seller</th><th>Price</th><th>Action</th></tr></thead>
                <tbody id="adminAllProducts"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let currentUser = null;
    let products = [];
    let isEditing = false;

    // AUTH
    let isLogin = true;
    function toggleAuthMode() {
        isLogin = !isLogin;
        document.getElementById('loginForm').classList.toggle('hidden');
        document.getElementById('registerForm').classList.toggle('hidden');
    }

    async function handleLogin(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = { email: formData.get('email'), password: formData.get('password') };

        try {
            const res = await fetch('/api/auth/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            if (res.ok) {
                currentUser = await res.json();
                showApp();
            } else { alert('Login failed'); }
        } catch (e) { alert('Error: ' + e.message); }
    }

    async function handleRegister(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = {
            fullName: formData.get('fullName'), email: formData.get('email'),
            password: formData.get('password'), role: formData.get('role')
        };
        try {
            const res = await fetch('/api/auth/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            if (res.ok) {
                alert('Registration successful! Please login.');
                toggleAuthMode();
            } else { const error = await res.json(); alert(error.error); }
        } catch (e) { alert('Error: ' + e.message); }
    }

    function showApp() {
        document.getElementById('auth-view').classList.add('hidden');
        document.getElementById('app-view').classList.remove('hidden');
        document.getElementById('userName').textContent = currentUser.fullName;
        setupNav();
        loadShop();
    }

    function logout() {
        currentUser = null;
        document.getElementById('app-view').classList.add('hidden');
        document.getElementById('auth-view').classList.remove('hidden');
    }

    function setupNav() {
        const nav = document.getElementById('navLinks');
        let links = '<div class="nav-item active" onclick="switchView(\'shop\')">Shop</div>';
        if (currentUser.role === 'USER') {
            links += '<div class="nav-item" onclick="switchView(\'cart\')">Cart</div>';
            links += '<div class="nav-item" onclick="switchView(\'dashboard\')">Dashboard</div>';
        } else if (currentUser.role === 'SELLER') {
            links += '<div class="nav-item" onclick="switchView(\'seller\')">My Products</div>';
        } else if (currentUser.role === 'ADMIN') {
            links += '<div class="nav-item" onclick="switchView(\'admin\')">Admin</div>';
        }
        nav.innerHTML = links;
    }

    function switchView(view) {
        document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById(view + '-section').classList.remove('hidden');
        if (view === 'shop') loadShop();
        if (view === 'cart') loadCart();
        if (view === 'dashboard') loadDashboard();
        if (view === 'seller') loadSellerProducts();
        if (view === 'admin') { loadPendingProducts(); loadAdminAllProducts(); }
    }

    // SHOP & SEARCH
    async function loadShop() {
        const searchName = document.getElementById('searchName').value;
        const category = document.getElementById('searchCategory').value;
        const maxPrice = document.getElementById('searchMaxPrice').value;
        const maxCarbon = document.getElementById('searchMaxCarbon').value;

        let url = '/api/products?';
        if (searchName) url += `search=${searchName}&`;
        if (category !== 'All') url += `category=${category}&`;
        if (maxPrice) url += `maxPrice=${maxPrice}&`;
        if (maxCarbon) url += `maxCarbon=${maxCarbon}&`;

        const res = await fetch(url);
        products = await res.json();

        const grid = document.getElementById('productsGrid');
        grid.innerHTML = products.map(p => `
            <div class="product-card">
                <img src="${p.imageUrl || 'https://via.placeholder.com/200'}" class="product-img" alt="${p.name}">
                <h3>${p.name}</h3>
                <p style="color: #666; font-size: 0.9rem; margin: 5px 0;">${p.category}</p>
                <div style="display: flex; align-items: center; gap: 5px; margin: 10px 0;">
                    <i class="fas fa-leaf" style="color: var(--primary-green);"></i>
                    <span style="font-size: 0.9rem;">${p.carbonFootprint.toFixed(1)} kg CO2e</span>
                    <span class="badge badge-${p.ecoRating.replace('+','-plus')}">${p.ecoRating}</span>
                </div>
                <div style="margin: 5px 0; font-size: 0.9rem; color: ${p.quantity > 0 ? 'green' : 'red'};">
                    ${p.quantity > 0 ? `In Stock: ${p.quantity}` : 'Out of Stock'}
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: auto; padding-top: 10px;">
                    <strong style="font-size: 1.2rem;">$${p.price.toFixed(2)}</strong>
                    ${currentUser.role === 'USER' && p.quantity > 0 ? `<button class="btn btn-primary" onclick="addToCart(${p.id})">Add</button>` : ''}
                </div>
            </div>
        `).join('');
    }

    // CART
    async function addToCart(productId) {
        try {
            await fetch(`/api/cart/${currentUser.id}/items`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({productId, quantity: 1})
            });
            alert('Added to cart!');
        } catch (e) { alert('Error adding to cart'); }
    }

    async function loadCart() {
        const res = await fetch(`/api/cart/${currentUser.id}`);
        const cart = await res.json();
        const container = document.getElementById('cartItems');
        const totalEl = document.getElementById('cartTotal');
        if (cart.items.length === 0) {
            container.innerHTML = '<p>Your cart is empty.</p>';
            totalEl.textContent = '0.00';
            return;
        }
        let total = 0;
        container.innerHTML = cart.items.map(item => {
            total += item.price * item.quantity;
            return `
                <div style="display: flex; justify-content: space-between; background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px;">
                    <div><strong>${item.productName}</strong><br><small>${item.carbonFootprint} kg CO2e Ã— ${item.quantity}</small></div>
                    <div style="text-align: right;"><div>$${(item.price * item.quantity).toFixed(2)}</div><button class="btn btn-outline" onclick="removeFromCart(${item.id})">Remove</button></div>
                </div>`;
        }).join('');
        totalEl.textContent = total.toFixed(2);
    }

    async function removeFromCart(itemId) {
        await fetch(`/api/cart/${currentUser.id}/items/${itemId}`, {method: 'DELETE'});
        loadCart();
    }

    async function checkout() {
        try {
            const res = await fetch(`/api/orders/${currentUser.id}`, {method: 'POST'});
            const order = await res.json();
            alert(`Order placed! Total carbon: ${order.totalCarbonFootprint.toFixed(1)} kg CO2e`);
            loadCart();
        } catch (e) { alert('Checkout error'); }
    }

    // DASHBOARD (User) - Simplified for brevity (keep existing logic from previous response)
    async function loadDashboard() {
         const res = await fetch(`/api/carbon/report/${currentUser.id}`);
         const report = await res.json();
         // ... (Keep existing dashboard rendering code)
         document.getElementById('statsGrid').innerHTML = `
            <div class="stat-card"><div style="font-size: 3rem;">ðŸŒŸ</div><div class="stat-value">${report.ecoScore}</div><div class="stat-label">Eco Score</div></div>
            <div class="stat-card"><div style="font-size: 3rem;">ðŸŒ±</div><div class="stat-value">${report.carbonSaved.toFixed(1)} kg</div><div class="stat-label">Carbon Saved</div></div>
         `;
         // (Render charts logic remains same)
    }

    // IMAGE UPLOAD LOGIC
    async function uploadImageFile() {
        const input = document.getElementById('imageInput');
        const status = document.getElementById('uploadStatus');

        if (!input.files || input.files.length === 0) {
            alert("Please select a file first");
            return;
        }

        const formData = new FormData();
        formData.append("file", input.files[0]);

        status.textContent = "Uploading...";

        try {
            const res = await fetch('/api/images/upload', {
                method: 'POST',
                body: formData
            });

            if (res.ok) {
                const data = await res.json();
                document.getElementById('imagePathHidden').value = data.fileName; // Store filename
                status.textContent = "Upload successful! File: " + data.fileName;
                status.style.color = "green";
            } else {
                status.textContent = "Upload failed.";
                status.style.color = "red";
            }
        } catch (e) {
            status.textContent = "Error uploading.";
            console.error(e);
        }
    }

    // SELLER - ADD/EDIT
    async function handleProductSubmit(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = {
            userId: currentUser.id,
            name: formData.get('name'), description: formData.get('description'),
            price: parseFloat(formData.get('price')), quantity: parseInt(formData.get('quantity')),
            category: formData.get('category'), imageUrl: formData.get('imageUrl'),
            imagePath: formData.get('imagePath'), // Send uploaded path
            manufacturing: parseFloat(formData.get('manufacturing')), transportation: parseFloat(formData.get('transportation')),
            packaging: parseFloat(formData.get('packaging')), usage: parseFloat(formData.get('usage')), disposal: parseFloat(formData.get('disposal'))
        };

        const productId = document.getElementById('editProductId').value;
        const url = productId ? `/api/products/${productId}` : '/api/products/add';
        const method = productId ? 'PUT' : 'POST';

        try {
            const res = await fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            if (res.ok) {
                alert(productId ? 'Product Updated' : 'Product Added');
                resetForm();
                loadSellerProducts();
            } else { alert('Error saving product'); }
        } catch (e) { alert('Error: ' + e.message); }
    }

    function resetForm() {
        document.getElementById('addProductForm').reset();
        document.getElementById('editProductId').value = '';
        document.getElementById('imagePathHidden').value = '';
        document.getElementById('uploadStatus').textContent = '';
        document.getElementById('submitProductBtn').textContent = 'Add Product';
        document.getElementById('cancelEditBtn').style.display = 'none';
        isEditing = false;
    }

    function editProduct(product) {
        isEditing = true;
        document.getElementById('editProductId').value = product.id;
        document.getElementById('prodName').value = product.name;
        document.getElementById('prodPrice').value = product.price;
        document.getElementById('prodQuantity').value = product.quantity;
        document.getElementById('prodDesc').value = product.description;
        document.getElementById('prodCategory').value = product.category;
        document.getElementById('prodImage').value = product.imageUrl; // Generic URL (if any)

        // Note: We don't easily populate file inputs or hidden paths from DB for editing visually without extra logic,
        // but this allows re-uploading or keeping existing if not changed on backend.

        if (product.carbonBreakdown) {
            document.getElementById('prodManu').value = product.carbonBreakdown.manufacturing;
            document.getElementById('prodTrans').value = product.carbonBreakdown.transportation;
            document.getElementById('prodPack').value = product.carbonBreakdown.packaging;
            document.getElementById('prodUsage').value = product.carbonBreakdown.usage;
            document.getElementById('prodDisp').value = product.carbonBreakdown.disposal;
        }

        document.getElementById('submitProductBtn').textContent = 'Update Product';
        document.getElementById('cancelEditBtn').style.display = 'inline-block';
        document.querySelector('.main-content').scrollTop = 0; // Scroll to top
    }

    async function loadSellerProducts() {
        const res = await fetch(`/api/products/seller/${currentUser.id}`);
        const products = await res.json();
        document.getElementById('sellerProducts').innerHTML = products.length ?
            `<table class="data-table">
                <thead><tr><th>Name</th><th>Status</th><th>Qty</th><th>Price</th><th>Action</th></tr></thead>
                <tbody>${products.map(p => `
                    <tr>
                        <td>${p.name}</td>
                        <td>${p.verified ? '<span class="badge badge-A-plus">Verified</span>' : '<span class="badge badge-B">Pending</span>'}</td>
                        <td>${p.quantity}</td>
                        <td>$${p.price.toFixed(2)}</td>
                        <td><button class="btn btn-outline" onclick='editProduct(${JSON.stringify(p)})'>Edit</button></td>
                    </tr>`).join('')}</tbody>
            </table>` : '<p>No products yet.</p>';
    }

    // ADMIN
    async function loadPendingProducts() {
        const res = await fetch('/api/products/admin/pending');
        const products = await res.json();
        document.getElementById('pendingProducts').innerHTML = products.length ?
            products.map(p => `
                <tr><td>${p.name}</td><td>${p.sellerName}</td><td>${p.carbonFootprint.toFixed(1)} kg</td><td><button class="btn btn-primary" onclick="verifyProduct(${p.id})">Verify</button></td></tr>
            `).join('') : '<tr><td colspan="4">No pending products</td></tr>';
    }

    async function loadAdminAllProducts() {
        const search = document.getElementById('adminSearchName').value;
        const res = await fetch(`/api/products?search=${search || ''}`);
        const allProducts = await res.json();
        document.getElementById('adminAllProducts').innerHTML = allProducts.map(p => `
            <tr>
                <td>${p.id}</td>
                <td>${p.name}</td>
                <td>${p.sellerName}</td>
                <td>$${p.price}</td>
                <td>
                    <button class="btn btn-danger" onclick="deleteProduct(${p.id})">Delete</button>
                    <button class="btn btn-outline" onclick='editProduct(${JSON.stringify(p)}); switchView("seller");'>Edit</button>
                </td>
            </tr>
        `).join('');
    }

    async function verifyProduct(id) {
        await fetch(`/api/products/admin/verify/${id}?adminId=${currentUser.id}`, {method: 'PUT'});
        loadPendingProducts();
    }

    async function deleteProduct(id) {
        if (!confirm('Are you sure you want to delete this product?')) return;
        try {
            const res = await fetch(`/api/products/${id}?userId=${currentUser.id}`, {method: 'DELETE'});
            if (res.ok) { loadAdminAllProducts(); }
            else { alert('Failed to delete'); }
        } catch (e) { alert('Error deleting'); }
    }
</script>
</body>
</html>